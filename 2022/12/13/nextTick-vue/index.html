<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Vue中nextTick详解 - Undateable</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Undateable"><meta name="msapplication-TileImage" content="/img/logo1.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Undateable"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="this.message&amp;#x3D;’changed’就是更新DOM，更新DOM也是框架内部使用vm.nextTick来注册到微任务，所以先写this.message,再写this.nextTick来注册自己的回调函数，就会使得自己的回调函数在更新DOM之后执行。 123456789101112methods:&amp;amp;#123;example:function()&amp;amp;#123; &amp;#x2F;&amp;#x2F;修改数据 this.m"><meta property="og:type" content="blog"><meta property="og:title" content="Vue中nextTick详解"><meta property="og:url" content="http://example.com/2022/12/13/nextTick-vue/"><meta property="og:site_name" content="Undateable"><meta property="og:description" content="this.message&amp;#x3D;’changed’就是更新DOM，更新DOM也是框架内部使用vm.nextTick来注册到微任务，所以先写this.message,再写this.nextTick来注册自己的回调函数，就会使得自己的回调函数在更新DOM之后执行。 123456789101112methods:&amp;amp;#123;example:function()&amp;amp;#123; &amp;#x2F;&amp;#x2F;修改数据 this.m"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:published_time" content="2022-12-13T15:15:58.000Z"><meta property="article:modified_time" content="2022-12-13T15:23:50.959Z"><meta property="article:author" content="Liny"><meta property="article:tag" content="JS"><meta property="article:tag" content="Vue"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2022/12/13/nextTick-vue/"},"headline":"Vue中nextTick详解","image":["http://example.com/img/og_image.png"],"datePublished":"2022-12-13T15:15:58.000Z","dateModified":"2022-12-13T15:23:50.959Z","author":{"@type":"Person","name":"Liny"},"publisher":{"@type":"Organization","name":"Undateable","logo":{"@type":"ImageObject","url":"http://example.com/img/logo2.png"}},"description":"this.message&#x3D;’changed’就是更新DOM，更新DOM也是框架内部使用vm.nextTick来注册到微任务，所以先写this.message,再写this.nextTick来注册自己的回调函数，就会使得自己的回调函数在更新DOM之后执行。 123456789101112methods:&amp;#123;example:function()&amp;#123; &#x2F;&#x2F;修改数据 this.m"}</script><link rel="canonical" href="http://example.com/2022/12/13/nextTick-vue/"><link rel="icon" href="/img/logo1.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo2.png" alt="Undateable" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/resume">Resume</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Liny777/Liny777.github.io"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-12-13T15:15:58.000Z" title="2022/12/13 23:15:58">2022-12-13</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-12-13T15:23:50.959Z" title="2022/12/13 23:23:50">2022-12-13</time></span><span class="level-item"><a class="link-muted" href="/categories/FrontEnd/">FrontEnd</a></span><span class="level-item">23 minutes read (About 3432 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Vue中nextTick详解</h1><div class="content"><p>this.message&#x3D;’changed’就是更新DOM，更新DOM也是框架内部使用vm.nextTick来注册到微任务，所以先写this.message,再写this.nextTick来注册自己的回调函数，就会使得自己的回调函数在更新DOM之后执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">methods</span>:&#123;</span><br><span class="line"><span class="attr">example</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"> <span class="comment">//修改数据</span></span><br><span class="line"> <span class="variable language_">this</span>.<span class="property">message</span>=<span class="string">&#x27;changed&#x27;</span></span><br><span class="line"><span class="comment">//此时dom还没有跟新，不能获取新的数据</span></span><br><span class="line"> <span class="variable language_">this</span>.$nextTick(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="comment">//dom现在跟新了</span></span><br><span class="line">   <span class="comment">//可以获取新的dom数据，执行操作</span></span><br><span class="line">   <span class="variable language_">this</span>.<span class="title function_">doSomeThing</span>()</span><br><span class="line">  &#125;)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="Vue里的异步事件队列"><a href="#Vue里的异步事件队列" class="headerlink" title="Vue里的异步事件队列"></a>Vue里的异步事件队列</h1><p>用法：Vue.nextTick([callback,context])； 参数说明：</p>
<ol>
<li>&#96;&#96;&#96;arduino<br>{Function} [callback]：回调函数，不传时提供promise调用；<br>复制代码<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. ```css</span><br><span class="line">   &#123;Object&#125; [context]：回调函数执行的上下文环境，不传默认是自动绑定到调用它的实例上；</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>注意</strong>：<code>isNative</code>检查<code>value</code>是否是一个原生函数。</p>
<p><strong>场景</strong>：当我们使用vue操作更新dom后，需要对新的dom做一些操作时，但是这个时候，我们往往会获取不到更新后的DOM，因为这个时候，dom还没有重新渲染，所以我们就要使用vm.$nextTick方法。</p>
<p><strong>用法</strong>：nextTick接受一个回调函数作为参数，它的作用将回调延迟到下次DOM跟新周期之后执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">methods</span>:&#123;</span><br><span class="line"><span class="attr">example</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"> <span class="comment">//修改数据</span></span><br><span class="line"> <span class="variable language_">this</span>.<span class="property">message</span>=<span class="string">&#x27;changed&#x27;</span></span><br><span class="line"><span class="comment">//此时dom还没有跟新，不能获取新的数据</span></span><br><span class="line"> <span class="variable language_">this</span>.$nextTick(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="comment">//dom现在跟新了</span></span><br><span class="line">   <span class="comment">//可以获取新的dom数据，执行操作</span></span><br><span class="line">   <span class="variable language_">this</span>.<span class="title function_">doSomeThing</span>()</span><br><span class="line">  &#125;)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>DOM更新周期</strong>：在Vue当中，当视图状态发生变化时，watcher会得到通知，然后触发虚拟DOM的渲染流程，渲染这个操作不是同步的，是异步的。Vue中有一个队列，每当渲染时，会将watcher推送这个队列，在下一次事件循环中，让watcher触发渲染流程。</p>
<p><strong>使用异步队列的目的</strong>：提升效率。Vue2.0使用虚拟DOM来进行渲染，变化侦测的通知只发送到组件上，组件上的任意一个变化都会通知到一个watcher上，然后虚拟DOM会对整个组件进行对比（Diff算法），然后更新DOM。如果在同一轮事件循环中有两个数据发生变化，那么组件watcher会收到两次通知，从而进行两次渲染（同步更新也是两次渲染），事实上不需要渲染那么多次，只需要等所有状态都修改完毕后，一次性将整个组件的DOM渲染到最新即可。</p>
<p><strong>如何做到一次事件循环更新所有组件多次状态改变</strong>：将收到的watcher实例加入队列里缓存起来，并且再添加队列之前检查这个队列是否已存在相同watcher。不存在时，才能将watcher实例添加到队列中。然后再下一次事件循环中，Vue会让这个队列中的watcher触发渲染并清空队列。这样就保证一次事件循环组件多次状态改变只需要一次渲染更新。</p>
<p><strong>什么是事件循环</strong>：一门单线程非阻塞的脚本语言，执行js代码，只有一个主线程来处理所有任务。非阻塞是指当代代码需要处理异步任务时，主线程会挂起（pending），当异步任务处理完毕，主线程根据一定的规则去执行回调。事实上，当任务执行完毕，js会将这事件加入一个队列（事件队列）。被放入队列中的事件不会立刻执行其回调，而是当前执行栈中所有任务执行完毕后，主线程会去查找事件队列中是否有任务。异步任务有两种类型，微任务和宏任务。不同类型的任务会被分配到不同的任务队列中。执行栈中所有任务执行完毕后，主线程会去查找事件队列中是否有任务，如果存在，依次执行所有队列中的回调，直到为空，然后再去宏任务队列取出一个事件，把对应的回调加入当前执行栈，当前执行栈中所有任务都执行完毕，检查微任务队列是否有事件。无限循环，叫做事件循环。</p>
<p>⚠️<strong>注意</strong>：在事件循环中，必须当微任务队列中的事件都执行完之后，才会从宏任务队列中取出一个事件执行下一轮，所以添加到微任务队列中的任务的执行时间优先于宏任务队列中添加的任务。</p>
<h1 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a><strong>具体实现</strong></h1><p>由于vm.$nextTick会将回调 添加到任务队列中延迟执行，所以在回调执行前，如果反复调用vm.$nextTick，Vue.js并不会反复将回调添加到任务队列中，只会向任务队列中添加一个任务。此外，Vue.js内部有一个列表用来存储vm.$nextTick参数中提供的回调。在一轮事件循环中，vm.$nextTick只会向任务队列中添加一个任务，多次使用vm.$nextTick只会将回调添加到回调列表中缓存起来。当任务触发时，依次执行列表中的所有回调并清空列表。其代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> callbacks = []</span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushCallbacks</span> () &#123;</span><br><span class="line">	pending = <span class="literal">false</span></span><br><span class="line">	<span class="keyword">const</span> copies = callbacks.<span class="title function_">slice</span>(<span class="number">0</span>)</span><br><span class="line">	callbacks.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">		copies[i]()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> microTimerFunc</span><br><span class="line"><span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">microTimerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  p.<span class="title function_">then</span>(flushCallbacks)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">nextTick</span>(<span class="params">cb, ctx</span>) &#123;</span><br><span class="line">  callback.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(cb) &#123;</span><br><span class="line">      cb.<span class="title function_">call</span>(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span>(!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">microTimerFunc</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 测试一下</span></span><br><span class="line"><span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>) <span class="comment">// Berwin</span></span><br><span class="line">&#125;, &#123;<span class="attr">name</span>: <span class="string">&#x27;Berwin&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>​	在上面代码中，我们通过数组callbacks来存储用户注册的回调，声明了变量pending来标记是否已经向任务队列中添加了一个任务。每当向任务队列中插入任务时，将pending设置为true，每当任务被执行时将pending设置为false，这样就可以通过pending的值来判断是否需要向任务队列中添加任务。</p>
<p>​	上面我们还声明了flushCallbacks，它就是我们所说的被注册的那个任务。当这个函数被触发时，会将callbacks中的所有函数依次执行，然后清空callbacks，并将pending设置为false。也就是说，一轮事件循环中flushCallbacks只会执行一次。</p>
<p>​	上面我们还声明了microTimerFunc函数，它的作用是使用Promise.then将flushCallbacks添加到微任务队列中。</p>
<p>​	上面的准备工作完成后，当我们执行nextTick函数注册回调时，首先将回调函数添加到callbacks中，然后使用pending判断是否需要向任务队列中新增任务。</p>
<p>​	下面我们从执行的角度回顾nextTick的流程。首先，当nextTick被调用时，会将回调函数添加到callbacks中。如果此时是本轮事件循环第一次使用nextTick，那么需要向任务队列中添加任务。因此，我们使用microTimerFunc函数封装promise.then的作用就是将任务添加到微任务队列中。如果不是本轮事件循环中第一次调用nextTick，也就是说，此时任务队列中已经添加了一个执行回调列表的任务，那么我们就不需要执行microTimerFunc向任务队列中添加重复的任务，因为被添加到任务队列中的任务只需要执行一次，就可以将本轮事件循环中使用nextTick方法注册的回调都依次执行一遍。</p>
<p>​	下面是nextTick的内部注册流程和执行流程。</p>
<p>​	nextTick -&gt; 将回调添加到callbacks中 -&gt; 本轮事件循环中是否第一次使用nextTick？ </p>
<p>​	是 -》 向任务队列中添加任务 〉结束</p>
<p>​	否 -》结束</p>
<p>​	任务被执行 -〉依次执行callbacks中的所有回调 -》 清空callbacks</p>
<p>在Vue.js 2.4版本之前，nextTick方法在任何地方都使用微任务，但是微任务的优先级太高，在某些场景下可能会出现问题。所以Vue.js提供了在特殊场合下可以强制使用宏任务的方法。具体实现如下：</p>
<h1 id="考虑某些场景，将回调函数设置为宏任务"><a href="#考虑某些场景，将回调函数设置为宏任务" class="headerlink" title="考虑某些场景，将回调函数设置为宏任务"></a>考虑某些场景，将回调函数设置为宏任务</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> callbacks = []</span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushCallbacks</span> () &#123;</span><br><span class="line">	pending = <span class="literal">false</span></span><br><span class="line">	<span class="keyword">const</span> copies = callbacks.<span class="title function_">slice</span>(<span class="number">0</span>)</span><br><span class="line">	callbacks.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">		copies[i]()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> microTimerFunc</span><br><span class="line"><span class="keyword">let</span> macroTimerFunc = <span class="keyword">function</span>(<span class="params"></span>) &#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增代码</span></span><br><span class="line"><span class="keyword">let</span> useMacroTask = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">microTimerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	p.<span class="title function_">then</span>(flushCallbacks)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增代码</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">withMacroTask</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> fn.<span class="property">_withTask</span> || (fn.<span class="property">_withTask</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		useMacroTask = <span class="literal">true</span></span><br><span class="line">		<span class="keyword">const</span> res = fn.<span class="title function_">apply</span>(<span class="literal">null</span>, <span class="variable language_">arguments</span>)</span><br><span class="line">		useMacroTask = <span class="literal">false</span></span><br><span class="line">		<span class="keyword">return</span> res</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">nextTick</span> (cb, ctx) &#123;</span><br><span class="line">	callbacks.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (cb) &#123;</span><br><span class="line">			cb.<span class="title function_">call</span>(ctx)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">		pending = <span class="literal">true</span></span><br><span class="line">		<span class="comment">// 修改代码</span></span><br><span class="line">		<span class="keyword">if</span>(useMacroTask) &#123;</span><br><span class="line">			<span class="title function_">macroTimerFunc</span>()</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="title function_">microTimerFunc</span>()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	在上述代码中，新增了withMacroTask函数，它的作用是给回调函数做一层包装，保证在整个回调函数执行过程中，如果修改了状态（数据），那么更新DOM的操作会被推倒宏任务队列中。也就是说，更新DOM的执行时间会晚于回调函数的执行时间。</p>
<p>​	下面用点击事件举例。假设点击事件的回调使用了withMacroTask进行包装，那么在点击事件被触发时，如果回调中修改了数据，那么这个修改数据的操作所触发的更新DOM的操作会被添加到宏任务队列中。因为我们在nextTick中新增了判断语句，当useMacroTask为true时，则使用macroTimerFunc注册事件。</p>
<p>​	简单来说，被withMacroTask包裹的函数所使用的所有vm.nextTick方法都会将回调添加到宏任务队列中，其中包括状态被修改后触发的更新DOM的回调和用户自己使用vm.nextTick注册的回调等。</p>
<p>​	接下来，介绍macroTimerFunc时如何将回调函数添加到宏任务队列中的。</p>
<p>​	前面我们介绍过几种属于宏任务的事件，Vue.js优先使用setImmediate，但是它存在兼容性问题，只能在IE中使用，所以使用MessageChannel作为备选方案。如果浏览器也不支持MessageChannel，那么最后会使用setTimeout来将回调添加到宏任务队列中。</p>
<h1 id="设置宏任务的方法"><a href="#设置宏任务的方法" class="headerlink" title="设置宏任务的方法"></a>设置宏任务的方法</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(setImmediate)) &#123;</span><br><span class="line">	macroTImerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="title function_">setImmediate</span>(flushCallbacks)</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">MessageChannel</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; (<span class="title function_">isNative</span>(<span class="title class_">MessageChannel</span>) || <span class="title class_">MessageChannel</span>.<span class="title function_">toString</span>() === <span class="string">&#x27;[object MessageChannelConstructor]&#x27;</span>)) &#123;</span><br><span class="line">	<span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">MessageChannel</span>()</span><br><span class="line">	<span class="keyword">const</span> port = channel.<span class="property">port2</span></span><br><span class="line">	channel port1.<span class="property">onmessage</span> = flushCallbacks</span><br><span class="line">	macroTimerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">		port.<span class="title function_">postMessage</span>(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	macroTimerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">setTimeout</span>(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，macroTimerFunc被执行时，会将flushCallbacks添加到宏任务队列中。</p>
<p>前面提到microTimerFunc的实现原理是使用Promise.then, 但并不是所有浏览器都支持Promise，当不支持时，会降级成macroTimerFunc。其实实现方式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(<span class="title class_">Promise</span>)) &#123;</span><br><span class="line">	<span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">	microTimerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">		p.<span class="title function_">then</span>(flushCallbacks)</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	microTimerFunc = macroTimerFunc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先判断浏览器是否支持Promise，然后进行相应的处理即可。</p>
<p>官方文档中有这样一句话：如果没有提供回调且在支持Promise的环境中，则返回一个Promise。也就是说，可以这样使用vm.$nextTick:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.$nextTick(),<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="comment">// DOM 更新了</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>要实现这个功能，我们只需要在nextTick中进行判断，如果没有提供回调且当前环境支持Promise，那么返回Promise，并且在callbacks中添加一个函数，当这个函数执行时，执行Promise的resolve即可，代码如下：</p>
<h1 id="针对不支持Promise浏览器和支持Promise浏览器做的兼容处理"><a href="#针对不支持Promise浏览器和支持Promise浏览器做的兼容处理" class="headerlink" title="针对不支持Promise浏览器和支持Promise浏览器做的兼容处理"></a>针对不支持Promise浏览器和支持Promise浏览器做的兼容处理</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">nextTick</span> (cb, ctx) &#123;</span><br><span class="line">	<span class="comment">// 新增代码</span></span><br><span class="line">	<span class="keyword">let</span> _resolve</span><br><span class="line">	callbacks.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (cb) &#123;</span><br><span class="line">			cb.<span class="title function_">call</span>(ctx)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_resolve) &#123; <span class="comment">// 新增代码</span></span><br><span class="line">		  <span class="title function_">_resolve</span>(ctx)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (useMacroTask) &#123;</span><br><span class="line">      <span class="title function_">macroTimerFunc</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">microTimerFunc</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 新增代码</span></span><br><span class="line">  <span class="keyword">if</span> (!cb &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span> (<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	在上面的代码中，先在函数作用域中声明了_resolve，然后进行相应的处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> callbacks = [] <span class="comment">// 存储用户注册的回调</span></span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span> <span class="comment">// 声明了pending来标记是否已经向任务队列中添加了一个任务</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushCallbacks</span> () &#123;</span><br><span class="line">	pending = <span class="literal">false</span>  <span class="comment">// 每当任务被执行时将pending设置为false</span></span><br><span class="line">	<span class="keyword">const</span> copies = callbacks.<span class="title function_">slice</span>(<span class="number">0</span>)</span><br><span class="line">	callbacks.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">		copies[i]()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> microTimerFunc</span><br><span class="line"><span class="keyword">let</span> macroTimerFunc </span><br><span class="line"><span class="keyword">let</span> useMacroTask = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 宏任务的处理</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(setImmediate)) &#123;</span><br><span class="line">	macroTImerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="title function_">setImmediate</span>(flushCallbacks)</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">MessageChannel</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; (<span class="title function_">isNative</span>(<span class="title class_">MessageChannel</span>) || <span class="title class_">MessageChannel</span>.<span class="title function_">toString</span>() === <span class="string">&#x27;[object MessageChannelConstructor]&#x27;</span>)) &#123;</span><br><span class="line">	<span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">MessageChannel</span>()</span><br><span class="line">	<span class="keyword">const</span> port = channel.<span class="property">port2</span></span><br><span class="line">	channel port1.<span class="property">onmessage</span> = flushCallbacks</span><br><span class="line">	macroTimerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">		port.<span class="title function_">postMessage</span>(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	macroTimerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">setTimeout</span>(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Promise有效时</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(<span class="title class_">Promise</span>)) &#123;</span><br><span class="line">	<span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">	microTimerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">		p.<span class="title function_">then</span>(flushCallbacks)</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	microTimerFunc = macroTimerFunc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">withMacroTask</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> fn.<span class="property">_withTask</span> || (fn.<span class="property">_withTask</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		useMacroTask = <span class="literal">true</span></span><br><span class="line">		<span class="keyword">const</span> res = fn.<span class="title function_">apply</span>(<span class="literal">null</span>, <span class="variable language_">arguments</span>)</span><br><span class="line">		useMacroTask = <span class="literal">false</span></span><br><span class="line">		<span class="keyword">return</span> res</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">nextTick</span> (cb, ctx) &#123;</span><br><span class="line">	<span class="comment">// 新增代码</span></span><br><span class="line">	<span class="keyword">let</span> _resolve</span><br><span class="line">	callbacks.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123; <span class="comment">// 调用nextTick，就会将cb回调函数添加到callbacks中</span></span><br><span class="line">		<span class="keyword">if</span> (cb) &#123;</span><br><span class="line">			cb.<span class="title function_">call</span>(ctx)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_resolve) &#123; <span class="comment">// 新增代码</span></span><br><span class="line">		  <span class="title function_">_resolve</span>(ctx)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> (!pending) &#123; <span class="comment">// 如果是本轮事件第一次使用nextTick，就需要向任务队列添加任务</span></span><br><span class="line">    pending = <span class="literal">true</span> <span class="comment">// 每当向任务队列插入任务时，将pending设置为true</span></span><br><span class="line">    <span class="keyword">if</span> (useMacroTask) &#123;</span><br><span class="line">      <span class="title function_">macroTimerFunc</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">microTimerFunc</span>() <span class="comment">// 将flushCallbacks任务添加到微任务队列中</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 新增代码</span></span><br><span class="line">  <span class="keyword">if</span> (!cb &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span> (<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="article-licensing box"><div class="licensing-title"><p>Vue中nextTick详解</p><p><a href="http://example.com/2022/12/13/nextTick-vue/">http://example.com/2022/12/13/nextTick-vue/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Liny</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-12-13</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-12-13</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/JS/">JS</a><a class="link-muted mr-2" rel="tag" href="/tags/Vue/">Vue</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" href="https://www.buymeacoffee.com/1093742432A" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/12/09/PrototypeAndClass/"><span class="level-item">PrototypeAndClass</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "f00c99834bf0aa950f797a22c456768b",
            repo: "NewBlogComments",
            owner: "Liny777",
            clientID: "c215c3a16d68cf01d606",
            clientSecret: "056d890e249979b3eaabf0777d9780624b3d66d7",
            admin: ["Liny777"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Vue里的异步事件队列"><span class="level-left"><span class="level-item">1</span><span class="level-item">Vue里的异步事件队列</span></span></a></li><li><a class="level is-mobile" href="#具体实现"><span class="level-left"><span class="level-item">2</span><span class="level-item">具体实现</span></span></a></li><li><a class="level is-mobile" href="#考虑某些场景，将回调函数设置为宏任务"><span class="level-left"><span class="level-item">3</span><span class="level-item">考虑某些场景，将回调函数设置为宏任务</span></span></a></li><li><a class="level is-mobile" href="#设置宏任务的方法"><span class="level-left"><span class="level-item">4</span><span class="level-item">设置宏任务的方法</span></span></a></li><li><a class="level is-mobile" href="#针对不支持Promise浏览器和支持Promise浏览器做的兼容处理"><span class="level-left"><span class="level-item">5</span><span class="level-item">针对不支持Promise浏览器和支持Promise浏览器做的兼容处理</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo2.png" alt="Undateable" height="28"></a><p class="is-size-7"><span>&copy; 2022 Liny</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Liny777"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>